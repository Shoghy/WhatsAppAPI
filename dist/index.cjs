"use strict";Object.defineProperty(exports, "__esModule", {value: true});var __defProp=Object.defineProperty;var __defProps=Object.defineProperties;var __getOwnPropDescs=Object.getOwnPropertyDescriptors;var __getOwnPropSymbols=Object.getOwnPropertySymbols;var __hasOwnProp=Object.prototype.hasOwnProperty;var __propIsEnum=Object.prototype.propertyIsEnumerable;var __defNormalProp=(obj,key2,value)=>key2 in obj?__defProp(obj,key2,{enumerable:true,configurable:true,writable:true,value}):obj[key2]=value;var __spreadValues=(a,b)=>{for(var prop in b||(b={}))if(__hasOwnProp.call(b,prop))__defNormalProp(a,prop,b[prop]);if(__getOwnPropSymbols)for(var prop of __getOwnPropSymbols(b)){if(__propIsEnum.call(b,prop))__defNormalProp(a,prop,b[prop])}return a};var __spreadProps=(a,b)=>__defProps(a,__getOwnPropDescs(b));var __publicField=(obj,key2,value)=>__defNormalProp(obj,typeof key2!=="symbol"?key2+"":key2,value);var _rustingjs = require('rusting-js');function SafeFetch(input,init){return _rustingjs.catch_unwind.call(void 0, ()=>fetch(input,init))}var _enums = require('rusting-js/enums');var WSResponseErrorCode=(WSResponseErrorCode2=>{WSResponseErrorCode2[WSResponseErrorCode2["AuthException"]=0]="AuthException";WSResponseErrorCode2[WSResponseErrorCode2["APIMethod"]=3]="APIMethod";WSResponseErrorCode2[WSResponseErrorCode2["PermissionDenied"]=10]="PermissionDenied";WSResponseErrorCode2[WSResponseErrorCode2["AccessTokenHasExpired"]=190]="AccessTokenHasExpired";WSResponseErrorCode2[WSResponseErrorCode2["APIPermission1"]=200]="APIPermission1";WSResponseErrorCode2[WSResponseErrorCode2["APIPermission100"]=299]="APIPermission100";WSResponseErrorCode2[WSResponseErrorCode2["APITooManyCalls"]=4]="APITooManyCalls";WSResponseErrorCode2[WSResponseErrorCode2["RateLimitIssues"]=80007]="RateLimitIssues";WSResponseErrorCode2[WSResponseErrorCode2["RateLimitHit"]=130429]="RateLimitHit";WSResponseErrorCode2[WSResponseErrorCode2["SpamRateLimitHit"]=131048]="SpamRateLimitHit";WSResponseErrorCode2[WSResponseErrorCode2["PairRateLimitHit"]=131056]="PairRateLimitHit";WSResponseErrorCode2[WSResponseErrorCode2["AccountRegisterDeregisterRateLimitExceeded"]=133016]="AccountRegisterDeregisterRateLimitExceeded";WSResponseErrorCode2[WSResponseErrorCode2["TemporarilyBlockedForPoliciesViolations"]=368]="TemporarilyBlockedForPoliciesViolations";WSResponseErrorCode2[WSResponseErrorCode2["BusinessAccountIsRestrictedFromMessagingUsersInThisCountry"]=130497]="BusinessAccountIsRestrictedFromMessagingUsersInThisCountry";WSResponseErrorCode2[WSResponseErrorCode2["AccountHasBeenLocked"]=131031]="AccountHasBeenLocked";WSResponseErrorCode2[WSResponseErrorCode2["APIUnknown"]=1]="APIUnknown";WSResponseErrorCode2[WSResponseErrorCode2["APIService"]=2]="APIService";WSResponseErrorCode2[WSResponseErrorCode2["PhoneNumberIsNotValid"]=33]="PhoneNumberIsNotValid";WSResponseErrorCode2[WSResponseErrorCode2["InvalidParameter"]=100]="InvalidParameter";WSResponseErrorCode2[WSResponseErrorCode2["UserNumberIsPartOfAnExperiment"]=130472]="UserNumberIsPartOfAnExperiment";WSResponseErrorCode2[WSResponseErrorCode2["SomethingWentWrong"]=131e3]="SomethingWentWrong";WSResponseErrorCode2[WSResponseErrorCode2["AccessDenied"]=131005]="AccessDenied";WSResponseErrorCode2[WSResponseErrorCode2["RequiredParameterIsMissing"]=131008]="RequiredParameterIsMissing";WSResponseErrorCode2[WSResponseErrorCode2["ParameterValueIsNotValid"]=131009]="ParameterValueIsNotValid";WSResponseErrorCode2[WSResponseErrorCode2["ServiceUnavailable"]=131016]="ServiceUnavailable";WSResponseErrorCode2[WSResponseErrorCode2["RecipientCannotBeSender"]=131021]="RecipientCannotBeSender";WSResponseErrorCode2[WSResponseErrorCode2["MessageUndeliverable"]=131026]="MessageUndeliverable";WSResponseErrorCode2[WSResponseErrorCode2["BusinessEligibilityPaymentIssue"]=131042]="BusinessEligibilityPaymentIssue";WSResponseErrorCode2[WSResponseErrorCode2["IncorrectCertificate"]=131045]="IncorrectCertificate";WSResponseErrorCode2[WSResponseErrorCode2["ReEngagementMessage"]=131047]="ReEngagementMessage";WSResponseErrorCode2[WSResponseErrorCode2["MetaChoseNotToDeliver"]=131097]="MetaChoseNotToDeliver";WSResponseErrorCode2[WSResponseErrorCode2["UnsupportedMessageType"]=131051]="UnsupportedMessageType";WSResponseErrorCode2[WSResponseErrorCode2["MediaDownloadError"]=131052]="MediaDownloadError";WSResponseErrorCode2[WSResponseErrorCode2["MediaUploadError"]=131053]="MediaUploadError";WSResponseErrorCode2[WSResponseErrorCode2["AccountInMaintenanceMode"]=131057]="AccountInMaintenanceMode";WSResponseErrorCode2[WSResponseErrorCode2["TemplateParamCountMismatch"]=132e3]="TemplateParamCountMismatch";WSResponseErrorCode2[WSResponseErrorCode2["TemplateDoesNotExist"]=132001]="TemplateDoesNotExist";WSResponseErrorCode2[WSResponseErrorCode2["TemplateHydratedTextTooLong"]=132005]="TemplateHydratedTextTooLong";WSResponseErrorCode2[WSResponseErrorCode2["TemplateFormatCharacterPolicyViolated"]=13007]="TemplateFormatCharacterPolicyViolated";WSResponseErrorCode2[WSResponseErrorCode2["TemplateParameterFormatMismatch"]=132012]="TemplateParameterFormatMismatch";WSResponseErrorCode2[WSResponseErrorCode2["TemplateIsPaused"]=132015]="TemplateIsPaused";WSResponseErrorCode2[WSResponseErrorCode2["TemplateIsDisabled"]=132016]="TemplateIsDisabled";WSResponseErrorCode2[WSResponseErrorCode2["FlowIsBlocked"]=132068]="FlowIsBlocked";WSResponseErrorCode2[WSResponseErrorCode2["FlowIsThrottled"]=132069]="FlowIsThrottled";WSResponseErrorCode2[WSResponseErrorCode2["IncompleteDeregistration"]=13e3]="IncompleteDeregistration";WSResponseErrorCode2[WSResponseErrorCode2["TwoStepVerificationPinMismatch"]=133005]="TwoStepVerificationPinMismatch";WSResponseErrorCode2[WSResponseErrorCode2["PhoneNumberReVerificationNeeded"]=133006]="PhoneNumberReVerificationNeeded";WSResponseErrorCode2[WSResponseErrorCode2["TooManyTwoStepVerificationPinGuesses"]=133008]="TooManyTwoStepVerificationPinGuesses";WSResponseErrorCode2[WSResponseErrorCode2["TwoStepVerificationPinGuessedTooFast"]=13009]="TwoStepVerificationPinGuessedTooFast";WSResponseErrorCode2[WSResponseErrorCode2["PhoneNumberNotRegistered"]=133010]="PhoneNumberNotRegistered";WSResponseErrorCode2[WSResponseErrorCode2["PleaseWaitAFewMinutesBeforeAttemptingToRegisterThisPhoneNumber"]=133015]="PleaseWaitAFewMinutesBeforeAttemptingToRegisterThisPhoneNumber";WSResponseErrorCode2[WSResponseErrorCode2["GenericUserError"]=135e3]="GenericUserError";return WSResponseErrorCode2})(WSResponseErrorCode||{});var WSRequestError=class extends _enums.Enum.call(void 0, ){static FetchError(error){return this.create("FetchError",error)}static ParseError(error){return this.create("ParseError",error)}static ResponseError(error){return this.create("ResponseError",error)}};var WSError=class extends Error{constructor(json,message,type,code,fbtraceId,details,errorSubCode){super(message,{cause:"WhatsApp send a error response"});this.json=json;this.message=message;this.type=type;this.code=code;this.fbtraceId=fbtraceId;this.details=details;this.errorSubCode=errorSubCode}static FromJSON(json){return new this(json,json.message,json.type,json.code,json.fbtrace_id,json.error_data.details,json.error_subcode)}};var WhatsAppApi=class{constructor(graphApiToken,businessPhoneNumberId){__publicField(this,"headers");__publicField(this,"baseUrl");this.headers={Authorization:`Bearer ${graphApiToken}`,"Content-Type":"application/json"};this.baseUrl=`https://graph.facebook.com/v20.0/${businessPhoneNumberId}`}async SendTextMessage({phoneNumber,message,messageId,previewUrl}){const{headers,baseUrl}=this;const body={messaging_product:"whatsapp",text:{body:message},to:phoneNumber};if(messageId){body.context={message_id:messageId}}if(previewUrl){body.text.preview_url=true}const result=await SafeFetch(`${baseUrl}/messages`,{method:"POST",headers,body:JSON.stringify(body)});return await this.HandleResponse(result)}async SendTemplateMessage({languageCode,name,phoneNumber,headerComponent,bodyComponent,buttonComponents=[]}){const{headers,baseUrl}=this;const body={messaging_product:"whatsapp",to:phoneNumber,type:"template",template:{name,language:{code:languageCode}}};const components=[];if(headerComponent){components.push(headerComponent.ToJSON())}if(bodyComponent){components.push(bodyComponent.ToJSON())}for(const button of buttonComponents){components.push(button.ToJSON())}if(components.length>0){body.template.components=components}const result=await SafeFetch(`${baseUrl}/messages`,{method:"POST",headers,body:JSON.stringify(body)});return await this.HandleResponse(result)}async HandleResponse(result){if(result.is_err()){return _enums.Err.call(void 0, WSRequestError.FetchError(result.unwrap_err()))}const response=result.unwrap();const jsonResult=await _rustingjs.catch_unwind.call(void 0, ()=>response.json());if(jsonResult.is_err()){return _enums.Err.call(void 0, WSRequestError.ParseError(jsonResult.unwrap_err()))}const responseJson=jsonResult.unwrap();if("error"in responseJson){return _enums.Err.call(void 0, WSRequestError.ResponseError(WSError.FromJSON(responseJson.error)))}return _enums.Ok.call(void 0, responseJson)}};var key="WHATSAPP_APP_KEY";var app=new Map;function WhatsApp(){const api=app.get(key);if(api===void 0){_rustingjs.panic.call(void 0, "The API hasn't been initialized")}return api}function SetUpWhatsAppAPI({graphApiToken,businessPhoneNumberId}){const api=new WhatsAppApi(graphApiToken,businessPhoneNumberId);app.set(key,api);return api}var ParamType=(ParamType2=>{ParamType2["Currency"]="currency";ParamType2["DateTime"]="date_time";ParamType2["Document"]="document";ParamType2["Image"]="image";ParamType2["Text"]="text";ParamType2["Video"]="video";return ParamType2})(ParamType||{});var BaseParam=class{constructor(type){this.type=type}ToJSON(){return{type:this.type}}};var CurrencyParam=class extends BaseParam{constructor({fallbackValue,code,amount1000}){super("currency");__publicField(this,"fallbackValue");__publicField(this,"code");__publicField(this,"amount1000");this.fallbackValue=fallbackValue;this.code=code;this.amount1000=amount1000}ToJSON(){return{type:this.type,currency:{fallback_value:this.fallbackValue,code:this.code,amount_1000:this.amount1000}}}};var DateTimeParam=class extends BaseParam{constructor(fallbackValue){super("date_time");this.fallbackValue=fallbackValue}ToJSON(){return{type:this.type,date_time:{fallback_value:this.fallbackValue}}}};var MediaParam=class extends BaseParam{constructor(type,caption){super(type);__publicField(this,"caption");__publicField(this,"link");__publicField(this,"id");if(caption){this.caption=caption}}ToJSON(){const fieldName=this.type;const obj={};if(this.id!==void 0){obj[fieldName]={id:this.id}}else if(this.link!==void 0){obj[fieldName]={link:this.link}}else{_rustingjs.panic.call(void 0, "Neither of `link` or `id` are defined")}if(this.caption){obj[fieldName].caption=this.caption}return __spreadProps(__spreadValues({},obj),{type:this.type})}};var DocumentParam=class extends MediaParam{constructor({caption,filename}){super("document",caption);__publicField(this,"filename");if(filename){this.filename=filename}}static FromId(id,props={}){const obj=new this(props);obj.id=id;return obj}static FromLink(link,props={}){const obj=new this(props);obj.link=link;return obj}ToJSON(){const prev=super.ToJSON();if(this.filename){prev.document.filename=this.filename}return prev}};var ImageParam=class extends MediaParam{static FromId(id,caption){const obj=new this("image",caption);obj.id=id;return obj}static FromLink(link,caption){const obj=new this("image",caption);obj.link=link;return obj}};var TextParam=class extends BaseParam{constructor(text){super("text");this.text=text}ToJSON(){return{type:this.type,text:this.text}}};var VideoParam=class extends MediaParam{static FromId(id,caption){const obj=new this("video",caption);obj.id=id;return obj}static FromLink(link,caption){const obj=new this("video",caption);obj.link=link;return obj}};var ButtonParamType=(ButtonParamType2=>{ButtonParamType2["Payload"]="payload";ButtonParamType2["Text"]="text";return ButtonParamType2})(ButtonParamType||{});var BaseButtonParam=class{constructor(type){this.type=type}ToJSON(){return{type:this.type}}};var ButtonPayloadParam=class extends BaseButtonParam{constructor(payload){super("payload");this.payload=payload}ToJSON(){return{type:this.type,payload:this.payload}}};var ButtonTextParam=class extends BaseButtonParam{constructor(text){super("payload");this.text=text}ToJSON(){return{type:this.type,text:this.text}}};var ComponentType=(ComponentType2=>{ComponentType2["Body"]="body";ComponentType2["Header"]="header";ComponentType2["Button"]="button";return ComponentType2})(ComponentType||{});var Component=class{constructor(type){this.type=type}ToJSON(){return{type:this.type}}};var ParamBaseComponent=class extends Component{constructor(type,parameters){super(type);this.parameters=parameters}ToJSON(){const obj={type:this.type};const{parameters}=this;const paramsJSON=[];for(const p of parameters){paramsJSON.push(p.ToJSON())}if(paramsJSON.length>0){obj.parameters=paramsJSON}return obj}};var BodyComponent=class extends ParamBaseComponent{constructor(parameters){super("body",parameters)}};var HeaderComponent=class extends ParamBaseComponent{constructor(parameters){super("header",parameters)}};var ButtonComponentType=(ButtonComponentType2=>{ButtonComponentType2["QuickReply"]="quick_reply";ButtonComponentType2["Url"]="url";ButtonComponentType2["Catalog"]="catalog";return ButtonComponentType2})(ButtonComponentType||{});var BaseButtonComponent=class extends Component{constructor(subType,index){super("button");this.subType=subType;this.index=index}ToJSON(){return{type:"button",sub_type:this.subType,index:this.index.toString()}}};var QuickReplyButtonComponent=class extends BaseButtonComponent{constructor(payload,index){super("quick_reply",index);this.payload=payload}ToJSON(){const prev=super.ToJSON();return __spreadProps(__spreadValues({},prev),{parameters:[{type:"payload",payload:this.payload}]})}};var UrlButtonComponent=class extends BaseButtonComponent{constructor(text,index){super("url",index);this.text=text}ToJSON(){const prev=super.ToJSON();return __spreadProps(__spreadValues({},prev),{parameters:[{type:"text",text:this.text}]})}};var CatalogButtonComponent=class extends BaseButtonComponent{constructor(param,index){super("catalog",index);this.param=param}ToJSON(){const prev=super.ToJSON();return __spreadProps(__spreadValues({},prev),{parameters:[this.param.ToJSON()]})}};exports.BaseButtonComponent = BaseButtonComponent; exports.BaseButtonParam = BaseButtonParam; exports.BaseParam = BaseParam; exports.BodyComponent = BodyComponent; exports.ButtonComponentType = ButtonComponentType; exports.ButtonParamType = ButtonParamType; exports.ButtonPayloadParam = ButtonPayloadParam; exports.ButtonTextParam = ButtonTextParam; exports.CatalogButtonComponent = CatalogButtonComponent; exports.ComponentType = ComponentType; exports.CurrencyParam = CurrencyParam; exports.DateTimeParam = DateTimeParam; exports.DocumentParam = DocumentParam; exports.HeaderComponent = HeaderComponent; exports.ImageParam = ImageParam; exports.ParamType = ParamType; exports.QuickReplyButtonComponent = QuickReplyButtonComponent; exports.SetUpWhatsAppAPI = SetUpWhatsAppAPI; exports.TextParam = TextParam; exports.UrlButtonComponent = UrlButtonComponent; exports.VideoParam = VideoParam; exports.WSError = WSError; exports.WSRequestError = WSRequestError; exports.WSResponseErrorCode = WSResponseErrorCode; exports.WhatsApp = WhatsApp; exports.WhatsAppApi = WhatsAppApi;
